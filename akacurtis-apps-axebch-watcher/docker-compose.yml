services:
  app_proxy:
    environment:
      APP_HOST: backend
      APP_PORT: 3001

  backend:
    image: python:3.12-alpine
    restart: unless-stopped
    stop_grace_period: 1m
    volumes:
      - ${APP_DATA_DIR}/data:/data
      - ${APP_DIR}/backend.py:/app/backend.py:ro
    working_dir: /app
    command: >
      sh -c "pip install --no-cache-dir flask pyyaml >/dev/null &&
             python /app/backend.py"
    # Backend stays on default app network for app_proxy communication

  watcher:
    image: python:3.12-alpine
    restart: unless-stopped
    environment:
      POLL_SECONDS: "15"
      STATE_FILE: "/data/state.json"
      PYTHONUNBUFFERED: "1"
    volumes:
      - ${APP_DATA_DIR}/data:/data
      - ${APP_DIR}/watcher.py:/app/watcher.py:ro
    working_dir: /app
    command: >
      sh -c "pip install --no-cache-dir requests pyyaml >/dev/null &&
             python /app/watcher.py"
    depends_on:
      - backend
    networks:
      - default
      - umbrel_main_network

networks:
  umbrel_main_network:
    external: true
    name: umbrel_main_network
